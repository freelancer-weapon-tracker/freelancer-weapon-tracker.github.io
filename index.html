<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="" id="theme-color-meta">
  <title>Hitman Freelancer Tracker</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="images/favicon.svg">
  <link rel="icon" type="image/png" sizes="192x192" href="images/favicon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="images/favicon-512x512.png">
  <link rel="manifest" href="site.webmanifest">
  
  <link rel="stylesheet" href="css/style.css">
  <script src="js/locations.js"></script>
  <script src="js/weapons.js"></script>
</head>

<body>
  <div class="container">
    <h1 class="title">Hitman Freelancer Tracker</h1>
    <div class="button-container">
      <button class="filter-button" onclick="toggleSettingsMenu()">Settings</button>
      <div class="progress-container">
        <div id="collected-count"></div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
      </div>
      <button class="reset-btn" onclick="toggleResetMenu()">Reset</button>
    </div>
    <div class="filter-container">
      <div class="filter-menu-container">
        <div class="filter-menu">
          <div class="filters-section">
            <div class="section-title">Displayed Types</div>
            <label><input type="checkbox" data-rarity="tool" checked onchange="updateRarities()"> Tool</label>
            <label><input type="checkbox" data-rarity="common" checked onchange="updateRarities()"> Common</label>
            <label><input type="checkbox" data-rarity="rare" checked onchange="updateRarities()"> Rare</label>
            <label><input type="checkbox" data-rarity="epic" checked onchange="updateRarities()"> Epic</label>
            <label><input type="checkbox" data-rarity="legendary" checked onchange="updateRarities()"> Legendary</label>
          </div>
          <div class="filters-section">
            <div class="section-title">UI</div>
            <label><input type="checkbox" id="darkModeCheckbox">Dark Mode</label>
          </div>
          <div class="filters-section">
            <div class="section-title">Filtering</div>
            <label><input type="checkbox" id="showCollectedCheckbox" onchange="toggleShowCollected()"> Show Collected
              Weapons</label>
          </div>
        </div>
      </div>
    </div>
    <div class="reset-menu-container">
      <div class="reset-menu">
        <div class="section-title">Reset Options</div>
        <div class="reset-menu-buttons">
          <button data-reset-type="tools" onclick="confirmReset(this)">Reset Only<br />Freelancer Tools</button>
          <button data-reset-type="all" onclick="confirmReset(this)">Reset <b><u>ALL</u></b><br />Weapons and
            Tools</button>
        </div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="showTab('locations')">Weapons <span class="subword">By Location</span></div>
      <div class="tab" onclick="showTab('weapons')">Weapons Individually</div>
    </div>
    <div id="locations" class="tab-content active"></div>
    <div id="weapons" class="tab-content"></div>
    <div class="done-container tab-content hidden">
      <div>All weapons collected.</div>
      <br>
      <div>Use the <a href="#" class="reset-link" onclick="toggleResetMenu(); return false;">Reset</a> menu to reset.</div>
    </div>
    <!-- Move history below the done-container -->
    <hr id="history-separator" class="history-separator">
    <div id="collection-history-container" class="collection-history-container">
      <div id="collection-history-title" class="collection-history-title">
        Collection History
      </div>
      <ul id="collection-history" class="collection-history-list"></ul>
    </div>
  </div>
  
  <footer class="footer">
    <a href="https://github.com/hitman-freelancer-tracker/hitman-freelancer-tracker.github.io" target="_blank" rel="noopener noreferrer">View on GitHub</a>
  </footer>

  <script>
    let collectedWeapons = [];
    let collectionHistory = []; // {name, date, rarity}
    let showCollected = false;
    let selectedRarities = new Set(["legendary", "epic", "rare", "common", "tool"]);
    const rarityOrder = {
      legendary: 1,
      epic: 2,
      rare: 3,
      common: 4,
      tool: 5,
    };

    function showTab(tab) {
      let tabElement = document.getElementById(tab);
      if (tabElement.classList.contains('active')) {
        return;
      }
      document.querySelectorAll('.tab').forEach(tabBtn => tabBtn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.querySelector(`.tab[onclick="showTab('${tab}')"]`).classList.add('active');
      document.getElementById(tab).classList.add('active');
    }

    function renderLocations() {
      const locationsContainer = document.getElementById('locations');
      locationsContainer.innerHTML = '';
      // Sort locations so "Showdowns - All Locations" is always first
      const locationNames = Object.keys(locations).sort((a, b) => {
        if (a === "Showdowns - All Locations") return -1;
        if (b === "Showdowns - All Locations") return 1;
        return a.localeCompare(b);
      });
      locationNames.forEach(location => {
        let weapons = locations[location];
        weapons.sort((a, b) => {
          const rarityA = weaponsData[a.name].rarity;
          const rarityB = weaponsData[b.name].rarity;
          const rarityComparison = getRarityOrder(rarityA) - getRarityOrder(rarityB);
          if (rarityComparison !== 0) {
            return rarityComparison;
          }
          return a.name.localeCompare(b.name);
        });

        let accordionButton = document.createElement('button');
        accordionButton.className = 'accordion';
        accordionButton.dataset.location = location;

        let locationNameSpan = document.createElement('span');
        locationNameSpan.textContent = location;
        locationNameSpan.className = 'location-name'
        accordionButton.appendChild(locationNameSpan);

        let rarityDiv = document.createElement('div');
        rarityDiv.className = 'rarity-indicator';
        accordionButton.appendChild(rarityDiv);

        accordionButton.onclick = function () {
          togglePanel(this);
        };

        let panelDiv = document.createElement('div');
        panelDiv.className = 'panel';
        weapons.forEach(weapon => {
          let weaponData = weaponsData[weapon.name];
          let weaponDiv = document.createElement('div');
          weaponDiv.className = 'weapon' + (collectedWeapons.includes(weapon.name) ? ' collected' : '');
          weaponDiv.dataset.weapon = weapon.name;
          weaponDiv.onclick = () => toggleWeapon(weapon.name);

          let rarityRectangle = document.createElement('div');
          rarityRectangle.className = 'rarity-rectangle-weapon ' + weaponData.rarity.toLowerCase();

          let weaponInfoDiv = document.createElement('div');
          weaponInfoDiv.className = 'weapon-info';

          let weaponNameSpan = document.createElement('span');
          weaponNameSpan.className = 'weapon-name';
          weaponNameSpan.textContent = weapon.name;

          let placeholderValueSpan = document.createElement('span');
          placeholderValueSpan.className = 'weapon-value';
          placeholderValueSpan.textContent = `${weaponData.value} M ● ${weaponData.locations.length} Maps`;

          let rightRarityRectangle = document.createElement('div');
          rightRarityRectangle.className = 'rarity-rectangle-weapon right ' + weaponData.rarity.toLowerCase();

          weaponInfoDiv.appendChild(weaponNameSpan);

          weaponDiv.appendChild(rarityRectangle);
          weaponDiv.appendChild(weaponInfoDiv);
          weaponDiv.appendChild(createDescriptionSpan(weapon.description));
          weaponDiv.appendChild(rightRarityRectangle);

          panelDiv.appendChild(weaponDiv);
        });
        locationsContainer.appendChild(accordionButton);
        locationsContainer.appendChild(panelDiv);
      });
      updateVisibility();
      renderRarityCounters();
      renderCollectedCount();
      renderCollectionHistory(); // <-- render history after locations
    }

    function renderWeapons() {
      const weaponsContainer = document.getElementById('weapons');
      weaponsContainer.innerHTML = '';
      Object.keys(weaponsData).forEach(weaponName => {
        let weaponData = weaponsData[weaponName];

        let weaponDiv = document.createElement('div');
        weaponDiv.className = 'weapon' + (collectedWeapons.includes(weaponName) ? ' collected' : '');
        weaponDiv.dataset.weapon = weaponName;
        weaponDiv.onclick = () => toggleWeapon(weaponName, weaponDiv);

        let rarityRectangle = document.createElement('div');
        rarityRectangle.className = 'rarity-rectangle-weapon ' + weaponData.rarity.toLowerCase();

        let weaponInfoDiv = document.createElement('div');
        weaponInfoDiv.className = 'weapon-info';

        let weaponNameSpan = document.createElement('span');
        weaponNameSpan.className = 'weapon-name';
        weaponNameSpan.textContent = weaponName;

        let placeholderValueSpan = document.createElement('span');
        placeholderValueSpan.className = 'weapon-value';
        placeholderValueSpan.textContent = `${weaponData.value} M ● Avail. 2 other destinations`;

        weaponInfoDiv.appendChild(weaponNameSpan);
        //weaponInfoDiv.appendChild(placeholderValueSpan);

        let locationsSpan = document.createElement('span');
        locationsSpan.className = 'description';
        locationsSpan.textContent = weaponsData[weaponName].locations.join(' | ');

        weaponDiv.appendChild(rarityRectangle);
        weaponDiv.appendChild(weaponInfoDiv);
        weaponDiv.appendChild(locationsSpan);

        weaponsContainer.appendChild(weaponDiv);
      });
      updateVisibility();
      renderCollectedCount();
    }

    function createDescriptionSpan(description) {
      let descriptionSpan = document.createElement('span');
      descriptionSpan.className = 'description';
      const parts = description.split(';');
      parts.forEach(part => {
        const trimmedPart = part.trim();
        if (trimmedPart) {
          const line = document.createElement('div');
          line.textContent = `• ${trimmedPart}`;
          descriptionSpan.appendChild(line);
        }
      });
      return descriptionSpan;
    }

    function togglePanel(accordion) {
      let panel = accordion.nextElementSibling;
      let isOpen = accordion.classList.contains('active');

      document.querySelectorAll('.accordion').forEach(accordion => accordion.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(panel => panel.style.maxHeight = null);

      if (!isOpen) {
        accordion.classList.add('active');
        panel.style.maxHeight = panel.scrollHeight + 'px';
      }
    }

    let justSelectedWeapon = false;
    function toggleWeapon(weaponName) {
      if (justSelectedWeapon) {
        return;
      }
      justSelectedWeapon = true;
      const weaponDivs = document.querySelectorAll(`div[data-weapon="${weaponName}"]`);
      weaponDivs.forEach(weaponDiv => {
        if (!weaponDiv.classList.contains('collected')) {
          weaponDiv.classList.add('collected');
        } else {
          weaponDiv.classList.remove('collected');
        }
      });
      if (collectedWeapons.includes(weaponName)) {
        collectedWeapons = collectedWeapons.filter(weapon => weapon !== weaponName);
        removeFromCollectionHistory(weaponName);
      } else {
        collectedWeapons.push(weaponName);
        addToCollectionHistory(weaponName);
      }
      saveState();
      setTimeout(function () {
        justSelectedWeapon = false;
        renderRarityCounters();
        updateVisibility();
        renderCollectedCount();
      }, 500);
    }

    function confirmReset(button) {
      var resetType = button.dataset.resetType;
      let message = resetType === "tools" ?
        "Are you sure you want to reset your collection for all freelancer tools? Weapons will be unaffected." :
        "Are you sure you want to reset your collection for all weapons and freelancer tools?"
      if (confirm(message)) {
        if (resetType === "tools") {
          // Remove tools from collectedWeapons and history
          collectedWeapons = collectedWeapons.filter(weaponName => weaponsData[weaponName].rarity.toLowerCase() !== "tool");
          collectionHistory = collectionHistory.filter(entry => weaponsData[entry.name]?.rarity?.toLowerCase() !== "tool");
        } else {
          collectedWeapons = [];
          collectionHistory = [];
        }
        saveState();
        closeResetMenu();
        renderLocations();
        renderWeapons();
      }
    }



    function toggleFilterMenu() {
      const filterMenu = document.querySelector('.filters');
      filterMenu.classList.toggle('active');
    }

    function updateVisibility() {
      let allWeaponsCollected = true;
      document.querySelectorAll('.weapon').forEach(weaponDiv => {
        let weaponName = weaponDiv.querySelector('.weapon-name').textContent;
        let weaponData = weaponsData[weaponName];
        let weaponRarity = weaponData.rarity.toLowerCase();
        if (collectedWeapons.includes(weaponName) && !showCollected) {
          weaponDiv.classList.add('hidden');
        } else if (selectedRarities.has(weaponRarity)) {
          weaponDiv.classList.remove('hidden');
        } else {
          weaponDiv.classList.add('hidden');
        }
        if (selectedRarities.has(weaponRarity) && !collectedWeapons.includes(weaponName)) {
          allWeaponsCollected = false;
        }
      });

      // Hide locations with no visible weapons
      document.querySelectorAll('.accordion').forEach(accordion => {
        let location = accordion.dataset.location;
        let weaponsInLocation = locations[location];
        let panel = accordion.nextElementSibling;
        let visibleWeapons = Array.from(panel.children).filter(weaponDiv => !weaponDiv.classList.contains('hidden'));
        let hasInScopeWeapons = weaponsInLocation.some(weapon => selectedRarities.has(weaponsData[weapon.name].rarity.toLowerCase()));
        if (!hasInScopeWeapons || (visibleWeapons.length === 0 && !showCollected)) {
          accordion.classList.add('hidden');
          accordion.classList.remove('active');
          panel.style.maxHeight = null;
        } else {
          accordion.classList.remove('hidden');
        }
      });

      document.querySelectorAll('.done-container').forEach(container => {
        if (allWeaponsCollected && !showCollected) {
          container.classList.remove('hidden');
        } else {
          container.classList.add('hidden');
        }
      })

      let totalWeaponsCount = 0;
      let collectedWeaponsCount = 0;
      collectedWeapons.forEach((collectedWeapon) => {
        if (!selectedRarities.has(collectedWeapon.rarity)) {
          return;
        }
        collectedWeaponsCount++;
      });


    }

    function toggleShowCollected() {
      showCollected = !showCollected;
      document.body.classList.toggle("show-collected-weapons", showCollected);
      saveState();
      updateVisibility();
    }

    function renderRarityCounters() {
      // Clear existing rarity indicators
      document.querySelectorAll('.rarity-indicator').forEach(indicator => indicator.innerHTML = '');

      // Loop through each location
      Object.keys(locations).forEach(locationName => {
        const rarityIndicators = document.querySelector(`.accordion[data-location="${locationName}"] .rarity-indicator`);
        const weaponsInLocation = locations[locationName];

        // Initialize counts
        const collected = collectedWeapons.filter(w => weaponsInLocation.some(weapon => weapon.name === w));
        const totalRarityCounts = {};
        const remainingRarityCounts = {};

        Object.keys(rarityOrder).forEach(rarity => {
          totalRarityCounts[rarity] = 0;
          remainingRarityCounts[rarity] = 0;
        });

        // Calculate counts
        weaponsInLocation.forEach(weapon => {
          const weaponData = weaponsData[weapon.name];
          if (!weaponData || !weaponData.rarity) {
            throw new Error(`Weapon ${weapon.name} in location ${locationName} is missing a rarity.`);
          }

          const rarity = weaponData.rarity.toLowerCase();
          if (!selectedRarities.has(rarity)) return;

          totalRarityCounts[rarity]++;
          if (!collected.includes(weapon.name)) {
            remainingRarityCounts[rarity]++;
          }
        });
        // Render rarity indicators
        const sortedRarities = Object.keys(totalRarityCounts).sort((a, b) => getRarityOrder(a) - getRarityOrder(b));
        rarityIndicators.innerHTML = sortedRarities.filter(rarity => remainingRarityCounts[rarity] > 0).map(rarity => {
          const count = remainingRarityCounts[rarity];
          return `<div class="rarity-rectangle-location ${rarity}">${count}</div>`;
        }).join('');
      });
    }

    function updateRarities() {
      selectedRarities = new Set();
      document.querySelectorAll('[data-rarity]').forEach(checkbox => {
        if (checkbox.checked) {
          selectedRarities.add(checkbox.dataset.rarity);
        }
      });
      saveState();
      updateVisibility();
      renderRarityCounters();
      renderCollectedCount();
    }

    function toggleSettingsMenu() {
      closeResetMenu();
      const filterMenu = document.querySelector('.filter-menu-container');
      const filterButton = document.querySelector('.filter-button');
      let expandedMaxHeight = filterMenu.scrollHeight + 'px';
      if (filterMenu.style.maxHeight !== expandedMaxHeight) {
        filterMenu.style.maxHeight = filterMenu.scrollHeight + 'px';
        filterButton.textContent = 'Hide Settings';
      } else {
        closeSettingsMenu(filterMenu, filterButton);
      }
    }

    function closeSettingsMenu(filterMenu, filterButton) {
      filterMenu = filterMenu || document.querySelector('.filter-menu-container');
      filterButton = filterButton || document.querySelector('.filter-button');
      filterMenu.style.maxHeight = '0';
      filterButton.textContent = 'Settings';
    }

    function toggleResetMenu() {
      closeSettingsMenu();
      const resetMenuContainer = document.querySelector('.reset-menu-container');
      const resetButton = document.querySelector('.reset-btn');
      let expandedMaxHeight = resetMenuContainer.scrollHeight + 'px';
      if (resetMenuContainer.style.maxHeight !== expandedMaxHeight) {
        resetMenuContainer.style.maxHeight = resetMenuContainer.scrollHeight + 'px';
        resetButton.textContent = 'Hide Reset';
      } else {
        closeResetMenu(resetMenuContainer, resetButton);
      }
    }

    function closeMenus() {
      closeResetMenu();
      closeSettingsMenu();
    }

    function closeResetMenu(resetMenuContainer, resetButton) {
      resetMenuContainer = resetMenuContainer || document.querySelector('.reset-menu-container');
      resetButton = resetButton || document.querySelector('.reset-btn');
      resetMenuContainer.style.maxHeight = '0';
      resetButton.textContent = 'Reset';
    }

    function renderCollectedCount() {
      const totalWeapons = Object.values(weaponsData).filter(weaponData => selectedRarities.has(weaponData.rarity.toLowerCase())).length;
      const collectedCount = collectedWeapons.filter(weaponName => selectedRarities.has(weaponsData[weaponName].rarity.toLowerCase())).length;
      document.getElementById('collected-count').innerHTML = `<b>Collected</b><br/>${collectedCount}/${totalWeapons}`;
      
      // Update progress bar
      const progressPercentage = totalWeapons > 0 ? (collectedCount / totalWeapons) * 100 : 0;
      const progressFill = document.getElementById('progress-fill');
      progressFill.style.width = `${progressPercentage}%`;
      
      // Update progress bar color
      if (collectedCount === totalWeapons && progressPercentage === 100) {
        // Special 100% completion
        progressFill.className = 'progress-fill complete';
        progressFill.style.background = ''; // Clear inline style to use CSS class
      } else {
        // Smooth color interpolation from red to green with gradient
        progressFill.className = 'progress-fill';
        progressFill.style.background = getProgressColor(progressPercentage);
      }
    }

    function getProgressColor(percentage) {
      // Smooth interpolation from red (0%) to green (99%)
      // Red: #e74c3c (231, 76, 60)
      // Green: #27ae60 (39, 174, 96)
      
      const startColor = { r: 231, g: 76, b: 60 };   // Red
      const endColor = { r: 39, g: 174, b: 96 };     // Green
      
      // Normalize percentage to 0-1 range
      const ratio = Math.min(percentage / 100, 0.99); // Cap at 99% to reserve 100% for special green
      
      // Interpolate each color component
      const r = Math.round(startColor.r + (endColor.r - startColor.r) * ratio);
      const g = Math.round(startColor.g + (endColor.g - startColor.g) * ratio);
      const b = Math.round(startColor.b + (endColor.b - startColor.b) * ratio);
      
      // Create gradient effect with slightly lighter right side
      const baseColor = `rgb(${r}, ${g}, ${b})`;
      const lighterColor = `rgb(${Math.min(255, r + 25)}, ${Math.min(255, g + 25)}, ${Math.min(255, b + 25)})`;
      
      return `linear-gradient(90deg, ${baseColor}, ${lighterColor})`;
    }

    function renderCollectionHistory() {
      const historyList = document.getElementById('collection-history');
      const historyTitle = document.getElementById('collection-history-title');
      const historyContainer = document.getElementById('collection-history-container');
      historyList.innerHTML = '';
      document.getElementById('history-separator').style.display = '';
      
      // Remove any existing empty message div
      const existingEmptyMsg = historyContainer.querySelector('.collection-history-empty');
      if (existingEmptyMsg) {
        existingEmptyMsg.remove();
      }
      
      if (!collectionHistory.length) {
        // Show faint message if no weapons collected as a separate div
        const emptyMsg = document.createElement('div');
        emptyMsg.className = 'collection-history-empty';
        emptyMsg.textContent = 'No weapons collected';
        historyContainer.appendChild(emptyMsg);
        return;
      }
      collectionHistory.forEach((entry, idx) => {
        const li = document.createElement('li');
        const infoDiv = document.createElement('div');
        infoDiv.className = 'history-item-info';
        
        const weaponNameDiv = document.createElement('div');
        weaponNameDiv.innerHTML = `<b>${entry.name}</b>`;
        
        const collectionTimeDiv = document.createElement('div');
        collectionTimeDiv.className = 'collection-time';
        const date = new Date(entry.date);
        const dateString = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        collectionTimeDiv.textContent = `Collected ${dateString}`;
        
        infoDiv.appendChild(weaponNameDiv);
        infoDiv.appendChild(collectionTimeDiv);
        
        const undoBtn = document.createElement('button');
        undoBtn.textContent = 'Undo';
        undoBtn.onmousedown = function(e) { e.stopPropagation(); };
        undoBtn.onclick = function(e) {
          e.stopPropagation();
          undoCollect(entry.name, /*keepAccordionOpen*/true);
        };
        li.appendChild(infoDiv);
        li.appendChild(undoBtn);
        historyList.appendChild(li);
      });
    }

    function addToCollectionHistory(weaponName) {
      // Remove any previous entry for this weapon
      collectionHistory = collectionHistory.filter(e => e.name !== weaponName);
      // Add new entry at the top
      collectionHistory.unshift({
        name: weaponName,
        date: Date.now(),
        rarity: weaponsData[weaponName]?.rarity?.toLowerCase() || ''
      });
      saveState();
      renderCollectionHistory();
    }

    function removeFromCollectionHistory(weaponName) {
      collectionHistory = collectionHistory.filter(e => e.name !== weaponName);
      saveState();
      renderCollectionHistory();
    }

    function undoCollect(weaponName, keepAccordionOpen) {
      // Find which accordion (if any) is open and its scroll state
      let openAccordion = document.querySelector('.accordion.active');
      let openLocation = openAccordion ? openAccordion.dataset.location : null;
      let panelScroll = null;
      let openPanel = openAccordion && openAccordion.nextElementSibling ? openAccordion.nextElementSibling : null;
      if (openPanel) {
        panelScroll = openPanel.scrollTop;
      }
      // Un-collect weapon and remove from history
      collectedWeapons = collectedWeapons.filter(w => w !== weaponName);
      removeFromCollectionHistory(weaponName);
      saveState();

      // Instead of renderLocations(), just update the .collected class in the DOM for visible weapons
      document.querySelectorAll('.weapon').forEach(weaponDiv => {
        if (weaponDiv.dataset.weapon === weaponName) {
          weaponDiv.classList.remove('collected');
        }
      });
      // Also update in the "Weapons Individually" tab
      document.querySelectorAll(`#weapons .weapon[data-weapon="${weaponName}"]`).forEach(weaponDiv => {
        weaponDiv.classList.remove('collected');
      });

      renderWeapons();
      renderRarityCounters();
      renderCollectedCount();
      updateVisibility();
      renderCollectionHistory();

      // Restore scroll position if needed
      if (openPanel && panelScroll !== null) {
        openPanel.scrollTop = panelScroll;
      }

      // --- Fix for location reappearing but not being openable ---
      // If a location was hidden and now appears, and it was previously open, forcibly open it
      if (openLocation && false) {
        const acc = document.querySelector(`.accordion[data-location="${openLocation}"]`);
        const panel = acc ? acc.nextElementSibling : null;
        if (acc && !acc.classList.contains('active')) {
          acc.classList.add('active');
          if (panel) {
            panel.style.maxHeight = panel.scrollHeight + 'px';
          }
        }
      }
    }

    function initializeWeaponsData() {
      Object.keys(weaponsData).forEach(weaponName => {
        let weaponData = weaponsData[weaponName];
        weaponData.locations = [];
        Object.keys(locations).forEach(location => {
          if (locations[location].some(weapon => weapon.name === weaponName)) {
            weaponData.locations.push(location);
          }
        });
      });
      Object.keys(locations).forEach(location => {
        let weapons = locations[location];
        weapons.forEach(weapon => {
          if (!(weapon.name in weaponsData)) {
            throw new Error("Weapon not recognized: " + weapon.name);
          }
        });
      });
    }

    function saveState() {
      localStorage.setItem('collectedWeapons', JSON.stringify(collectedWeapons));
      localStorage.setItem('collectionHistory', JSON.stringify(collectionHistory));
      const settings = {
        showCollected: showCollected,
        selectedRarities: Array.from(selectedRarities),
      };
      localStorage.setItem('settings', JSON.stringify(settings));
    }

    function loadState() {
      collectedWeapons = JSON.parse(localStorage.getItem('collectedWeapons')) || [];
      collectionHistory = JSON.parse(localStorage.getItem('collectionHistory')) || [];

      const settings = JSON.parse(localStorage.getItem('settings'));
      if (settings) {
        showCollected = settings.showCollected;
        selectedRarities = new Set(settings.selectedRarities);
        document.getElementById('showCollectedCheckbox').checked = showCollected || false;
        document.querySelectorAll('[data-rarity]').forEach(checkbox => {
          checkbox.checked = selectedRarities.has(checkbox.dataset.rarity)
        });
      };

      renderLocations();
      renderWeapons();
      renderRarityCounters();
      renderCollectedCount();
      updateVisibility();
      renderCollectionHistory();
    }

    function getRarityOrder(rarity) {
      return rarityOrder[rarity.toLowerCase()];
    }

    document.addEventListener('DOMContentLoaded', () => {
      initializeTheme();
      loadState();
      renderLocations();
      renderWeapons();
    });

    // Initialize theme color immediately based on system preference
    (function() {
      const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const savedTheme = localStorage.getItem('theme');
      let isDark;
      
      if (savedTheme) {
        isDark = savedTheme === 'dark';
      } else {
        isDark = prefersDarkMode;
      }
      
      const themeColorMeta = document.getElementById('theme-color-meta');
      if (themeColorMeta) {
        themeColorMeta.content = isDark ? '#121212' : '#ffffff';
      }
    })();

    function updateThemeColor(isDark) {
      // Update theme-color meta tag for status bar
      const themeColorMeta = document.getElementById('theme-color-meta');
      if (themeColorMeta) {
        themeColorMeta.content = isDark ? '#121212' : '#ffffff';
      }
    }

    function initializeTheme() {
      const checkbox = document.getElementById('darkModeCheckbox');

      // Check if the user has a saved preference
      const savedTheme = localStorage.getItem('theme');

      if (savedTheme) {
        const isDark = savedTheme === 'dark';
        document.body.classList.toggle('dark-mode', isDark);
        checkbox.checked = isDark;
        updateThemeColor(isDark);
      } else {
        // Initialize based on system preference
        const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.body.classList.toggle('dark-mode', prefersDarkMode);
        checkbox.checked = prefersDarkMode;
        updateThemeColor(prefersDarkMode);
      }

      // Toggle dark mode based on checkbox
      checkbox.addEventListener('change', function () {
        const isDark = checkbox.checked;
        if (isDark) {
          document.body.classList.add('dark-mode');
          localStorage.setItem('theme', 'dark');
        } else {
          document.body.classList.remove('dark-mode');
          localStorage.setItem('theme', 'light');
        }
        updateThemeColor(isDark);
      });
    }

    initializeWeaponsData();
  </script>
</body>

</html>
`
